{% load staticfiles %}
<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <title>{% block title %}{{ project_name }}{% endblock title %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link href="{% static 'css/social_buttons.css' %}" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="http://acanimal.github.io/Openlayers-Cookbook/recipes/data/green_theme/style.css">
    <style>
      body {
        padding-top: 51px; /* 51px to make the container go all the way to the bottom of the topbar */
      }
    </style>
    <link href="{% static 'css/bootstrap-responsive.min.css' %}" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- This file store project specific CSS -->
    <link href="{% static 'css/project.css' %}" rel="stylesheet">

    <!-- Use this to quickly test CSS changes in a template,
        then move to project.css -->
    {% block extra_css %}{% endblock extra_css %}
  </head>

  <body>

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container-fluid">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="#">Mapa do Cidadão</a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li class="active" id="menu-home"><a href="#">Home</a></li>
              <li class="" id="menu-about"><a href="{% url "about" %}">Sobre</a></li>
              <li class="" id="menu-contact"><a href="{% url "contact" %}">Contato</a></li>
            </ul>
            {% if user.is_anonymous %}
              <p class="navbar-text pull-right">
                <a href="{% url 'socialauth_begin' 'facebook' %}" class="btn btn-mini btn-facebook"><i class="fa fa-facebook"></i> | Login com o Facebook</a>
              </p>
            {% else %}
              <p class="navbar-text pull-right">
                <a href="#" class="navbar-link">
                    <i class="fa fa-user"></i> {{ user.first_name|default:"Not provided" }} {{ user.last_name|default:"" }}
                </a>
                <span class="divider">/</span>
                <a href="{% url 'logout' %}" class="navbar-link"><i class="fa fa-power-off"></i></a>
              </p>
            {% endif %}
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>
    <div class="container-full">
      {% block content %}
        <div id="map"></div>
      {% endblock content %}

    </div> <!-- /container -->

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script src="{% static 'js/openlayers/OpenLayers.js' %}"></script>

    <script src="{% static 'js/bootstrap.min.js' %}"></script>

    <!-- place project specific Javascript in this file -->
    <script src="{% static 'js/project.js' %}"></script>

    <script type="text/javascript">
var map;
var epsg4326 = new OpenLayers.Projection("EPSG:4326");
var epsg900913 = new OpenLayers.Projection("EPSG:900913");
var wkt = new OpenLayers.Format.WKT();

function init() {
    map = new OpenLayers.Map({
        div: "map",
        projection: "EPSG:900913",
        fractionalZoom: true,
        layers: [new OpenLayers.Layer.OSM()],
        controls: [
            new OpenLayers.Control.Navigation({
                dragPanOptions: {
                    enableKinetic: true
                }
            }),
            // new OpenLayers.Control.Zoom(),
            new OpenLayers.Control.ScaleLine(),
            new OpenLayers.Control.MousePosition(),
            new OpenLayers.Control.Permalink(),
        ]
    });
}

function popup_clear() {
    while(map.popups.length) {
         map.removePopup(map.popups[0]);
    }
}

function feature_click(event) {
    popup_clear();
    var feature = event.feature;
    var content = "<h2>" + feature.attributes.name + "</h2>" + feature.attributes.description;

    popup = new OpenLayers.Popup.FramedCloud(
        "chicken",
        feature.geometry.getBounds().getCenterLonLat(),
        new OpenLayers.Size(100, 100),
        content,
        null,
        true,
        popup_clear
    );
    feature.popup = popup;
    map.addPopup(popup);
}

function load_ocorrencias() {
    var ocorrencia_layer = new OpenLayers.Layer.Vector("Ocorrências");

    var ocorrencias_wkt = [
        {% for ocorrencia in ocorrencias %}
        {
            {% if ocorrencia.type == 'poligono' %}
            'wkt': '{{ ocorrencia.poligono.wkt|safe }}',
            {% else %}
            'wkt': '{{ ocorrencia.ponto.wkt|safe }}',
            {% endif %}
            'name': '{{ ocorrencia.titulo }}',
            'description': '{{ ocorrencia.descricao|escapejs }}',
            'pk': '{{ ocorrencia.pk }}',
            'stylesheet': {{ ocorrencia.get_estilo|safe }},
        },
        {% endfor %}
    ];
    var ocorrencias_features = [];

    var ocorrencias_wkt_len = ocorrencias_wkt.length;
    for (var i = ocorrencias_wkt_len; i--;) {
        var feature = wkt.read(ocorrencias_wkt[i].wkt);
        feature.attributes.name = ocorrencias_wkt[i].name;
        feature.attributes.description = ocorrencias_wkt[i].description;
        feature.style = ocorrencias_wkt[i].style;
        ocorrencias_features.push(feature);
    }

    ocorrencia_layer.addFeatures(ocorrencias_features);
    ocorrencia_layer.events.register('featureclick', ocorrencia_layer, feature_click);
    ocorrencia_layer.events.register('nofeatureclick', ocorrencia_layer, popup_clear);
    map.addLayer(ocorrencia_layer);
    map.addControl(new OpenLayers.Control.DrawFeature(ocorrencia_layer, OpenLayers.Handler.Point));
}

function load_cidade_geom() {
    var geojson_format = new OpenLayers.Format.GeoJSON();

    var sjc_lonlat = new OpenLayers.LonLat(-45.88555, -23.17960).transform(epsg4326, epsg900913);
    var zoom = 15;
    map.setCenter(sjc_lonlat, zoom);

    var cidade_layer = new OpenLayers.Layer.Vector("Limites de São José dos Campos");
    map.addLayer(cidade_layer);

    $.ajax({
        dataType: "json",
        url: "/get_current_geom/",
        success: function (data) {
            var features = geojson_format.read(data);

            if (features.length >= 1) {
                var feature = features[0];
                feature.style = {
                    fillColor: '#FFF',
                    fillOpacity: 0
                };

                map.setOptions({
                    restrictedExtent: feature.geometry.getBounds(),
                    numZoomLevels: 10
                });

                cidade_layer.addFeatures([feature]);

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function (position) {
                        var current_lonlat = new OpenLayers.LonLat(
                            position.coords.longitude,
                            position.coords.latitude
                        ).transform(epsg4326, epsg900913);

                        var current_point = new OpenLayers.Geometry.Point(
                            current_lonlat.lon,
                            current_lonlat.lat
                        );

                        if (feature.geometry.intersects(current_point)) {
                            map.setCenter(current_point, zoom);
                        }
                    });
                }
            }
        }
    });
}
    </script>
    {% block extra_js %}
    <script type="text/javascript">
        $(document).ready(function(){
          init();
          load_cidade_geom();
          load_ocorrencias();
        });
    </script>

    {% endblock extra_js %}
  </body>
</html>
